<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá Th·ªëng B√†y H√†ng GitHub V19.0 - C·∫≠p Nh·∫≠t L·ªçc Theo Tu·ªïi</title>
    <style>
        :root { --p: #ee4d2d; --s: #1877f2; --g: #00b894; --dark: #2d3436; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 15px; }
        .card-step { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 6px solid var(--s); }
        .num-circle { background: var(--dark); color: white; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 10px; font-weight: bold; }
        .lucky-char { color: red; font-size: 20px; font-weight: 900; text-decoration: underline; }
        .btn { padding: 15px 20px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; width: 100%; margin: 8px 0; transition: 0.2s; font-size: 16px; }
        .btn-shopee { background: #ee4d2d; }
        .btn-edit { background: #00d2d3; }
        .btn-upload { background: #5f27cd; }
        .btn-ai { background: var(--g); width: 48%; display: inline-block; }
        .market { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
        .item { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; }
        .item:hover { border-color: var(--p); transform: translateY(-5px); }
        .item img { width: 100%; height: 120px; object-fit: cover; border-radius: 5px; }
        .price-tag { color: #ee4d2d; font-weight: bold; display: block; margin-top: 5px; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:1000; overflow-y:auto; }
        .modal-content { background: white; width: 95%; max-width: 550px; margin: 10px auto; padding: 20px; border-radius: 20px; }
        .sub-step { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid var(--s); }
        input { width: 100%; padding: 12px; margin-top: 8px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .add-friend-box { background: #e3f2fd; padding: 10px; border-radius: 10px; margin-top: 15px; border: 1px dashed var(--s); }
    </style>
</head>
<body>

<h1 style="text-align:center; color: var(--s);">üè™ SI√äU TH·ªä GITHUB V19.0</h1>

<div class="card-step" style="border-color: #ff9f43;">
    <h3><span class="num-circle">1</span> N·∫†P KHO & <span class="num-circle">2</span> NG∆Ø·ªúI MAY M·∫ÆN</h3>
    <input type="file" id="csv" accept=".csv" style="margin-bottom:15px">
    <div id="luckyBox" style="font-size: 18px; text-align: center; background: #eee; padding: 15px; border-radius: 10px;">
        H√¥m nay: <b id="luckyName">---</b> (<span id="luckyAge">--</span> tu·ªïi)
    </div>
    <div class="add-friend-box">
        <input type="text" id="newFriendName" placeholder="H·ªç v√† T√™n...">
        <div style="display: flex; gap: 5px;">
            <input type="number" id="newFriendYear" placeholder="NƒÉm sinh">
            <input type="text" id="newFriendGender" placeholder="Nam/N·ªØ">
        </div>
        <button class="btn" style="background:var(--s); font-size:14px" onclick="addNewFriend()">+ TH√äM B·∫†N M·ªöI</button>
    </div>
</div>

<div class="card-step" style="border-color: #00d2d3;">
    <h3><span class="num-circle">3</span> CH·ªåN QU√Ä THEO ƒêI·ªÄU KI·ªÜN (Tu·ªïi > Gi√° > Ch·ªØ Cu·ªëi)</h3>
    <div id="market" class="market"></div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="mTitle" style="text-align: center; color: var(--p);"></h2>
        <div class="sub-step"><b>üëâ B∆Ø·ªöC 4: L·∫§Y ·∫¢NH G·ªêC</b><br><button class="btn btn-shopee" onclick="goShopee()">M·ªû SHOPEE</button></div>
        <div class="sub-step"><b>üëâ B∆Ø·ªöC 5: T·∫¢I ·∫¢NH L√äN</b><br><input type="text" id="imgLink" placeholder="D√°n Direct Link..."><input type="text" id="affLink" placeholder="D√°n Link r√∫t g·ªçn..."></div>
        <div class="sub-step"><b>üëâ B∆Ø·ªöC 6: NH·ªú AI</b><br><button class="btn btn-ai" onclick="askAI('Gemini')">Gemini</button></div>
        <button class="btn" style="background:#636e72" onclick="closeModal()">QUAY L·∫†I</button>
    </div>
</div>

<script>
    let fixedMems = JSON.parse(localStorage.getItem('my_friends_list')) || [
        {n:"NGUY·ªÑN KH·∫ÆC NƒÇNG", d:"1944", g:"Nam"}, 
        {n:"T√î TH·ªä H√Ä", d:"1948", g:"N·ªØ"},
        {n:"NGUY·ªÑN MINH NAM", d:"1971", g:"Nam"},
        {n:"TH√ÇN TH·ªä KIM ANH", d:"1981", g:"N·ªØ"}
    ];

    let warehouse = [];
    let lucky = null;
    const currentYear = new Date().getFullYear();

    function init() {
        const offset = Math.floor((new Date() - new Date("2026-01-01")) / (1000*60*60*24));
        lucky = fixedMems[offset % fixedMems.length];
        document.getElementById('luckyName').innerText = lucky.n;
        document.getElementById('luckyAge').innerText = currentYear - parseInt(lucky.d);
    }

    function addNewFriend() {
        const name = document.getElementById('newFriendName').value.toUpperCase().trim();
        const year = document.getElementById('newFriendYear').value.trim();
        const gender = document.getElementById('newFriendGender').value.trim();
        if(!name || !year) return alert("Nh·∫≠p thi·∫øu t√™n ho·∫∑c nƒÉm sinh!");
        fixedMems.push({n: name, d: year, g: gender});
        localStorage.setItem('my_friends_list', JSON.stringify(fixedMems));
        location.reload();
    }

    document.getElementById('csv').onchange = async (e) => {
        const text = await e.target.files[0].text();
        const lines = text.split('\n').slice(1);
        warehouse = lines.map(l => {
            const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if(c.length >= 4) return { 
                id: c[0].trim(), 
                name: c[1].replace(/"/g, ''), 
                price: parseFloat(c[2].replace(/[^0-9.-]+/g,"")) || 0, 
                img: c[3]?.trim().replace(/"/g, ''), 
                link: c[c.length-1].trim().replace(/"/g, ''), 
                aff: "", imgNew: "" 
            };
        }).filter(x => x);
        renderMarket();
    };

    function renderMarket() {
        const area = document.getElementById('market');
        area.innerHTML = "";
        
        // 1. L·∫•y t·∫•t c·∫£ c√°c ch·ªØ c√°i cu·ªëi t·ª´ H·ªç, T√™n ƒê·ªám, T√™n c·ªßa ng∆∞·ªùi may m·∫Øn
        // VD: "NGUY·ªÑN KH·∫ÆC NƒÇNG" -> ["N", "C", "G"]
        const luckyParts = lucky.n.split(" ");
        const luckyChars = luckyParts.map(p => p.slice(-1).toUpperCase());
        
        const age = currentYear - parseInt(lucky.d);

        // 2. L·ªçc s·∫£n ph·∫©m
        let filtered = warehouse.filter(p => {
            const pChar = p.name.trim().slice(-1).toUpperCase();
            // ƒêi·ªÅu ki·ªán: Ch·ªØ cu·ªëi s·∫£n ph·∫©m ph·∫£i n·∫±m trong danh s√°ch ch·ªØ cu·ªëi c·ªßa T√™n ng∆∞·ªùi
            return luckyChars.includes(pChar);
        });

        // 3. S·∫Øp x·∫øp theo Gi√° (V√¨ ng∆∞·ªùi l·ªõn tu·ªïi th∆∞·ªùng ∆∞u ti√™n gi√° tr·ªã ph√π h·ª£p)
        // B·∫°n c√≥ th·ªÉ ƒë·ªïi l·∫°i p.price - b.price t√πy theo mu·ªën gi√° cao hay th·∫•p l√™n tr∆∞·ªõc
        filtered.sort((a, b) => a.price - b.price);

        // 4. L·∫•y 3 m·∫∑t h√†ng ƒë·∫ßu ti√™n sau khi ƒë√£ l·ªçc v√† x·∫øp gi√°
        const finalItems = filtered.slice(0, 3);

        finalItems.forEach(p => {
            const item = document.createElement('div');
            item.className = 'item';
            item.onclick = () => {
                selected = p;
                document.getElementById('mTitle').innerText = p.name;
                document.getElementById('modal').style.display = 'block';
            };
            item.innerHTML = `
                <img src="${p.img}">
                <div style="font-size:14px; margin-top:5px">
                    ${p.name.slice(0,-1)}<span class="lucky-char">${p.name.slice(-1)}</span>
                </div>
                <span class="price-tag">${p.price.toLocaleString()}ƒë</span>
            `;
            area.appendChild(item);
        });

        if(finalItems.length === 0) area.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y m√≥n qu√† n√†o kh·ªõp v·ªõi ch·ªØ c√°i cu·ªëi n, h, m c·ªßa b·∫°n.</p>";
    }

    // C√°c h√†m goShopee, askAI, closeModal gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n...
    function goShopee() { navigator.clipboard.writeText(selected.link); window.open(selected.link, '_blank'); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function askAI(type) {
        selected.aff = document.getElementById('affLink').value;
        selected.imgNew = document.getElementById('imgLink').value;
        const prompt = `Vi·∫øt truy·ªán v·ªÅ ${lucky.n} (${currentYear - lucky.d} tu·ªïi). Do t√™n c√≥ ch·ªØ cu·ªëi kh·ªõp v·ªõi m√≥n qu√† ${selected.name} n√™n ƒë∆∞·ª£c t·∫∑ng. ·∫¢nh: ${selected.imgNew}`;
        navigator.clipboard.writeText(prompt);
        alert("ƒê√£ copy prompt!");
        window.open("https://gemini.google.com", '_blank');
    }

    init();
</script>
</body>
</html>

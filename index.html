<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá Th·ªëng Affiliate Gia ƒê√¨nh To√†n NƒÉng</title>
    <style>
        :root { --p: #ee4d2d; --s: #1877F2; --v: #9b59b6; --g: #27ae60; --dark: #2d3436; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: var(--p); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .step-num { background: var(--dark); color: white; padding: 5px 12px; border-radius: 50%; margin-right: 10px; }
        
        /* Friend Form */
        .friend-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: var(--dark); color: white; padding: 12px; }
        td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; }
        
        .btn { border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; transition: 0.3s; }
        .btn-ai { background: var(--v); margin: 2px; font-size: 11px; }
        .btn-github { background: #24292e; }
        .img-slot { width: 60px; height: 60px; border: 2px dashed #ccc; cursor: pointer; margin: auto; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .img-slot img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div style="max-width: 1200px; margin: auto;">
    
    <div class="box">
        <h2><span class="step-num">1</span> NH·∫¨P DANH S√ÅCH B·∫†N B√à</h2>
        <div class="friend-form">
            <input type="text" id="fName" placeholder="H·ªç v√† t√™n b·∫°n b√®...">
            <input type="number" id="fAge" placeholder="Tu·ªïi...">
            <select id="fGender">
                <option value="Nam">Nam</option>
                <option value="N·ªØ">N·ªØ</option>
            </select>
            <button class="btn" style="background:var(--s)" onclick="addFriend()">+ Th√™m B·∫°n</button>
        </div>
        <div id="friendTags" style="margin-top:10px"></div>
    </div>

    <div class="box">
        <h2><span class="step-num">2</span> NH·∫¨P KHO H√ÄNG (CSV NHI·ªÄU T·ªÜP)</h2>
        <input type="file" id="csvFiles" multiple accept=".csv">
        <p id="storageInfo" style="font-size:12px; color:#666; margin-top:5px"></p>
    </div>

    <div class="box">
        <h2><span class="step-num">3</span> B√ÄY H√ÄNG & CH·ªåN AI K·ªÇ CHUY·ªÜN</h2>
        <div style="margin-bottom:10px">
            <button class="btn btn-github" onclick="exportToGithub()">üì§ Xu·∫•t File B√†y H√†ng (GitHub)</button>
            <button class="btn" style="background:#d63031" onclick="cleanOldProducts()">üßπ X√≥a S·∫£n Ph·∫©m C≈© (>30 ng√†y)</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>·∫¢nh</th>
                    <th>S·ª≠a T√™n</th>
                    <th>Link Affiliate (B·ªë d√°n)</th>
                    <th>Ch·ªçn AI K·ªÉ Chuy·ªán</th>
                    <th>Xong</th>
                </tr>
            </thead>
            <tbody id="productArea"></tbody>
        </table>
    </div>

</div>

<script>
    let friends = JSON.parse(localStorage.getItem('myFriends') || '[]');
    let warehouse = JSON.parse(localStorage.getItem('myWarehouse') || '[]');

    // --- QU·∫¢N L√ù B·∫†N B√à ---
    function addFriend() {
        const name = document.getElementById('fName').value.trim();
        const age = document.getElementById('fAge').value;
        const gen = document.getElementById('fGender').value;
        if(!name) return;
        const lastChar = name.split(' ').pop().charAt(0).toUpperCase();
        friends.push({ name, age, gen, lastChar });
        localStorage.setItem('myFriends', JSON.stringify(friends));
        renderFriends();
    }

    function renderFriends() {
        document.getElementById('friendTags').innerHTML = friends.map(f => 
            `<span style="background:#eee; padding:5px 10px; border-radius:15px; margin-right:5px; font-size:12px">
                ${f.name} (${f.age}t - ${f.gen}) - Ch·ªØ cu·ªëi: ${f.lastChar}
            </span>`).join('');
    }

    // --- QU·∫¢N L√ù CSV NHI·ªÄU T·ªÜP ---
    document.getElementById('csvFiles').onchange = async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            const text = await file.text();
            const lines = text.split('\n').slice(1);
            lines.forEach(l => {
                const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if(c.length >= 8) {
                    const id = c[0].trim();
                    if(!warehouse.some(p => p.id === id)) {
                        warehouse.push({
                            id: id, 
                            raw: c[1]?.replace(/"/g, ''),
                            name: c[1]?.replace(/\[.*?\]|\(.*?\)/g, '').split(' ').slice(0, 5).join(' '),
                            l: c[8]?.trim() || c[7]?.trim(),
                            img: '', 
                            dateIn: new Date().getTime(),
                            done: false
                        });
                    }
                }
            });
        }
        saveWarehouse();
    };

    // --- K·ªÇ CHUY·ªÜN & AI ---
    function askAI(aiType, id) {
        const p = warehouse.find(x => x.id === id);
        const f = friends[Math.floor(Math.random() * friends.length)] || {name: "B·∫°n b√©"};
        const prompt = `H√£y k·ªÉ m·ªôt c√¢u chuy·ªán ng·ª• ng√¥n h√†i h∆∞·ªõc v·ªÅ "${f.name}" (${f.gen}) v√† m√≥n ƒë·ªì "${p.name}". K·∫øt th√∫c b·∫±ng l·ªùi khuy√™n mua h√†ng d√≠ d·ªèm t·∫°i: ${p.l}`;
        
        navigator.clipboard.writeText(prompt);
        
        let url = "";
        if(aiType === 'Gemini') url = "https://gemini.google.com/";
        if(aiType === 'DeepSeek') url = "https://chat.deepseek.com/";
        if(aiType === 'Grok') url = "https://x.com/i/grok";
        if(aiType === 'GPT') url = "https://chatgpt.com/";
        
        alert(`ƒê√£ copy l·ªánh cho ${aiType}. B√© h√£y d√°n v√†o nh√©!`);
        window.open(url, '_blank');
    }

    // --- QU·∫¢N L√ù KHO & GITHUB ---
    function saveWarehouse() {
        localStorage.setItem('myWarehouse', JSON.stringify(warehouse));
        renderWarehouse();
    }

    function cleanOldProducts() {
        const thirtyDays = 30 * 24 * 60 * 60 * 1000;
        const now = new Date().getTime();
        warehouse = warehouse.filter(p => (now - p.dateIn) < thirtyDays);
        saveWarehouse();
        alert("ƒê√£ d·ªçn d·∫πp s·∫£n ph·∫©m qu√° c≈©!");
    }

    function exportToGithub() {
        const data = "const myProducts = " + JSON.stringify(warehouse, null, 2);
        const blob = new Blob([data], {type: 'text/javascript'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'products.js';
        a.click();
        alert("B√© l·∫•y file n√†y ƒë·∫©y l√™n GitHub ƒë·ªÉ b√†y h√†ng nh√©!");
    }

    function uploadImg(id) {
        const inp = document.createElement('input');
        inp.type = 'file'; inp.accept = 'image/*';
        inp.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    cvs.width = 150; cvs.height = 150;
                    cvs.getContext('2d').drawImage(img, 0, 0, 150, 150);
                    const idx = warehouse.findIndex(p => p.id === id);
                    warehouse[idx].img = cvs.toDataURL('image/jpeg', 0.6);
                    saveWarehouse();
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };
        inp.click();
    }

    function renderWarehouse() {
        document.getElementById('storageInfo').innerText = `Trong kho ƒëang c√≥: ${warehouse.length} s·∫£n ph·∫©m.`;
        const tbody = document.getElementById('productArea');
        tbody.innerHTML = warehouse.slice(-20).reverse().map(p => `
            <tr class="${p.done ? 'done-row' : ''}">
                <td><div class="img-slot" onclick="uploadImg('${p.id}')">${p.img ? `<img src="${p.img}">` : '+'}</div></td>
                <td><input class="edit-name" style="width:100%" value="${p.name}" onchange="updateItem('${p.id}', 'name', this.value)"></td>
                <td><input style="width:100%; border:1px solid red" value="${p.l}" onchange="updateItem('${p.id}', 'l', this.value)"></td>
                <td>
                    <button class="btn btn-ai" onclick="askAI('Gemini', '${p.id}')">Gemini</button>
                    <button class="btn btn-ai" onclick="askAI('DeepSeek', '${p.id}')">DeepSeek</button>
                    <button class="btn btn-ai" onclick="askAI('GPT', '${p.id}')">GPT</button>
                </td>
                <td><input type="checkbox" ${p.done ? 'checked' : ''} onclick="updateItem('${p.id}', 'done', this.checked)"></td>
            </tr>
        `).join('');
    }

    function updateItem(id, key, val) {
        const idx = warehouse.findIndex(p => p.id === id);
        warehouse[idx][key] = val;
        localStorage.setItem('myWarehouse', JSON.stringify(warehouse));
        if(key === 'done') renderWarehouse();
    }

    renderFriends();
    renderWarehouse();
</script>
</body>
</html>
